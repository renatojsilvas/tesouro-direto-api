name: CI/CD DigitalOcean

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Restore dependencies
      run: dotnet restore src/TesouroDireto.Api/TesouroDireto.Api.csproj
    
    - name: Build
      run: dotnet build src/TesouroDireto.Api/TesouroDireto.Api.csproj --no-restore

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to DigitalOcean
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          # Create /app directory if not exists
          sudo mkdir -p /app
          sudo chown $USER:$USER /app
          
          # Clone repo if first time, otherwise pull
          if [ ! -d "/app/tesouro-direto-api" ]; then
            cd /app
            git clone ${{ github.server_url }}/${{ github.repository }}.git tesouro-direto-api
          fi
          
          cd /app/tesouro-direto-api
          git fetch origin
          git reset --hard origin/main
          
          cat > .env << EOF
          POSTGRES_HOST=postgres
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          REDIS_HOST=redis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          REDIS_PORT=6379
          ASPNETCORE_ENVIRONMENT=Production
          ASPNETCORE_URLS=http://+:8080
          EOF
          
          docker compose down --timeout 30
          docker system prune -f --volumes
          docker compose up --build -d --remove-orphans
          
          echo "Deploy completed!"